<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>휴대폰 관리</title>
<!-- Bootstrap CSS 추가 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container py-5">
    <h1 class="mb-4 text-center">휴대폰 관리</h1>

    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>phoneId</th>
                    <th>phoneName</th>
                    <th>phonePrice</th>
                    <th>phoneMaker</th>
                    <th>phoneRemain</th>
                </tr>
            </thead>
            <tbody id="phoneTbody">              
            </tbody>
        </table>
    </div>

    <hr class="my-4">

    <form class="row g-3">
        <div class="col-md-6">
            <input type="text" class="form-control" name="phoneId" id="phoneId" placeholder="ID">
        </div>        
        <div class="col-md-6">
            <input type="text" class="form-control" name="phoneName" id="phoneName" placeholder="이름">
        </div>
        <div class="col-md-6">
            <input type="text" class="form-control" name="phonePrice" id="phonePrice" placeholder="가격">
        </div>
        <div class="col-md-6">
            <input type="text" class="form-control" name="phoneMaker" id="phoneMaker" placeholder="제조사">
        </div>
        <div class="col-md-6">
            <input type="text" class="form-control" name="phoneRemain" id="phoneRemain" placeholder="재고">
        </div>
    </form>

    <hr class="my-4">

    <div class="d-flex justify-content-center gap-3">
        <button type="button" id="btnInsert" class="btn btn-primary">등록</button>
        <button type="button" id="btnUpdate" class="btn btn-warning">수정</button>
        <button type="button" id="btnDelete" class="btn btn-danger">삭제</button>
        <button type="button" class="btn btn-secondary" onclick="location.href='/'">홈</button>
    </div>

    <!-- JS 코드 -->
    <script>
        window.onload = function(){
            listPhone();
            document.querySelector("#btnInsert").onclick = insertPhone;
            document.querySelector("#btnUpdate").onclick = updatePhone;
            document.querySelector("#btnDelete").onclick = deletePhone;
        }   
        
        async function listPhone(){
            let url = '/phones/list';
            try{
                let response = await fetch(url);
                let data = await response.json();
                makeListHtml(data.phoneList);
            }catch(error){
                console.log(error);
                alert('휴대폰 목록 처리 중 오류 발생!');
            }           
        }
        
        async function makeListHtml(list){
            let listHTML = ``;
            list.forEach(el => {
                listHTML +=
                    `<tr style="cursor:pointer" data-phoneId="${el.id}">
                        <td>${el.id}</td>
                        <td>${el.name}</td>
                        <td>${el.price}</td>
                        <td>${el.maker}</td>
                        <td>${el.remain}</td>
                    </tr>`;
            });
            document.querySelector("#phoneTbody").innerHTML = listHTML;

            document.querySelectorAll("#phoneTbody tr").forEach(el => {
                el.onclick = function(){
                    let phoneId = this.getAttribute("data-phoneId");
                    detailPhone(phoneId);
                }
            });
        }   
        
        async function detailPhone(phoneId){
            let url = '/phones/detail/' + phoneId;
            try{
                let response = await fetch(url);
                let data = await response.json();
                
                document.querySelector("#phoneId").value = data.phoneDto.id;
                document.querySelector("#phoneName").value = data.phoneDto.name;
                document.querySelector("#phonePrice").value = data.phoneDto.price;
                document.querySelector("#phoneMaker").value = data.phoneDto.maker;
                document.querySelector("#phoneRemain").value = data.phoneDto.remain;
            }catch(error){
                console.error(error);
                alert('휴대폰 상세 처리 중 오류 발생!');
            }           
        }   
        
        async function insertPhone(){
            let urlParams = new URLSearchParams({                
                phoneName: document.querySelector("#phoneName").value,
                phonePrice: document.querySelector("#phonePrice").value,
                phoneMaker: document.querySelector("#phoneMaker").value,
                phoneRemain: document.querySelector("#phoneRemain").value,
            });
            
            let fetchOptions = {
                method: "POST",
                body: urlParams,
            }
            
            let url = '/phones/insert';
            
            try{
                let response = await fetch(url, fetchOptions);
                let data = await response.json();
                if( data.result == 'success' ){  
                    alert('휴대폰 등록!');
                    listPhone();   
                }else if (data.result == 'fail:already exisiting' ){
                    alert('이미 존재하는 휴대폰 입니다.');
                }
                
            }catch(error){
                console.error(error);
                alert('휴대폰 등록 처리 중 오류 발생!');
            }           
        }
        
        async function updatePhone(){
            let urlParams = new URLSearchParams({
                phoneId: document.querySelector("#phoneId").value,
                phoneName: document.querySelector("#phoneName").value,
                phonePrice: document.querySelector("#phonePrice").value,
                phoneMaker: document.querySelector("#phoneMaker").value,
                phoneRemain: document.querySelector("#phoneRemain").value,
            });
            
            let fetchOptions = {
                method: "POST",
                body: urlParams,
            }
            
            let url = '/phones/update';
            
            try{
                let response = await fetch(url, fetchOptions);
                let data = await response.json();
                alert('휴대폰 수정!');
                listPhone();
            }catch(error){
                console.error(error);
                alert('휴대폰 수정 처리 중 오류 발생!');
            }               
        }
        
        async function deletePhone(){
            let phoneId = document.querySelector("#phoneId").value;
            let url = '/phones/delete/' + phoneId;
            try{
                let response = await fetch(url);
                let data = await response.json();       
                alert('휴대폰 삭제!');
                listPhone();
            }catch(error){
                console.error(error);
                alert('휴대폰 삭제 처리 중 오류 발생!');
            }               
        }
    </script>
</body>
</html>
